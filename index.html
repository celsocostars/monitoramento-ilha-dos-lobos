<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGRE â€“ Ilha dos Lobos</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 10px;
  background: #f4f6f8;
}

h1 {
  text-align: center;
}

.filtros {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-bottom: 15px;
}

.filtros input, .filtros button {
  padding: 6px;
  font-size: 14px;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

th, td {
  padding: 8px;
  border: 1px solid #ccc;
  text-align: center;
}

th {
  background: #2c7be5;
  color: white;
}

tr.alerta {
  background: #ffd6d6;
}

@media (max-width: 600px) {
  table {
    font-size: 12px;
  }
}
</style>
</head>

<body>

<h1>SIGRE â€“ Monitoramento Ilha dos Lobos</h1>

<div class="filtros">
  <input type="date" id="filtroDia">
  <input type="time" id="filtroInicio">
  <input type="time" id="filtroFim">
  <label>
    <input type="checkbox" id="filtroAlerta"> Somente alertas
  </label>
  <button onclick="limparFiltros()">Limpar</button>
  <button onclick="exportarCSV()">CSV</button>
</div>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Latitude</th>
  <th>Longitude</th>
  <th>DistÃ¢ncia (m)</th>
  <th>Status</th>
  <th>Data/Hora</th>
</tr>
</thead>
<tbody id="tabela-dados">
<tr><td colspan="6">Aguardando dados...</td></tr>
</tbody>
</table>

<script>
/* ðŸ”¹ Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBr6MR_uXt8GTuc73w6tSxr5jW6kQwLntY",
  authDomain: "ilhalobos-3ab8f.firebaseapp.com",
  databaseURL: "https://ilhalobos-3ab8f-default-rtdb.firebaseio.com",
  projectId: "ilhalobos-3ab8f",
  storageBucket: "ilhalobos-3ab8f.appspot.com",
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

/* ðŸ”¹ ReferÃªncia */
const ref = database
  .ref("embarcacoes/esp32_01/historico")
  .limitToLast(30);

let dados = [];

ref.on("value", snap => {
  dados = [];
  snap.forEach(c => dados.push(c.val()));
  dados.reverse();
  atualizarTabela();
});

function atualizarTabela() {

  const tbody = document.getElementById("tabela-dados");
  tbody.innerHTML = "";

  const alerta = document.getElementById("filtroAlerta").checked;
  const dia = document.getElementById("filtroDia").value;
  const ini = document.getElementById("filtroInicio").value;
  const fim = document.getElementById("filtroFim").value;

  let filtrados = dados.filter(d => {

    if (alerta && d.status !== "DENTRO") return false;

    if (dia && !d.dataHora.startsWith(
      dia.split("-").reverse().join("/")
    )) return false;

    if (ini || fim) {
      const h = d.dataHora.split(" ")[1];
      if (ini && h < ini) return false;
      if (fim && h > fim) return false;
    }

    return true;
  });

  filtrados = filtrados.slice(0, 10);

  let i = 1;

  filtrados.forEach(d => {
    const tr = document.createElement("tr");
    if (d.status === "DENTRO") tr.classList.add("alerta");

    tr.innerHTML = `
      <td>${i++}</td>
      <td>${d.lat}</td>
      <td>${d.lon}</td>
      <td>${d.distancia}</td>
      <td>${d.status}</td>
      <td>${d.dataHora}</td>
    `;
    tbody.appendChild(tr);
  });

  if (filtrados.length === 0) {
    tbody.innerHTML =
      "<tr><td colspan='6'>Nenhum dado encontrado</td></tr>";
  }
}

function limparFiltros() {
  document.querySelectorAll(".filtros input").forEach(i => {
    if (i.type === "checkbox") i.checked = false;
    else i.value = "";
  });
  atualizarTabela();
}

function exportarCSV() {

  if (dados.length === 0) return alert("Sem dados");

  let csv = "Lat;Lon;Distancia;Status;DataHora\n";

  dados.slice(0, 10).forEach(d => {
    csv += `${d.lat};${d.lon};${d.distancia};${d.status};${d.dataHora}\n`;
  });

  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "sigre.csv";
  a.click();
}
</script>

</body>
</html>
